{"version":3,"sources":["../../../src/features/drag-and-drop/DragAndDrop.js"],"names":["classes","domClasses","domify","queryAll","domQueryAll","remove","domRemove","isInput","isOutput","Row","Col","forEach","TOP","RIGHT","BOTTOM","LEFT","DragAndDrop","components","elementRegistry","eventBus","dragAndDrop","renderer","rules","sheet","_cleanup","container","_renderer","getContainer","removeHighlight","removeFadeOut","_dragImage","_elementRegistry","_dragAndDrop","_rules","_sheet","onGetComponent","cellType","col","row","startDrag","e","title","on","event","dragContext","draggedElement","hoverEl","dropIndex","getTargetColIndex","allowed","index","targetEl","originalEvent","lastPosition","newPosition","getVerticalPosition","getHorizontalPosition","highlightRow","highlightCol","verticalPosition","rowId","dataset","get","targetRow","getTargetRow","getRoot","rows","horizontalPosition","colId","targetCol","getTargetCol","cols","element","document","body","appendChild","dataTransfer","setDragImage","fadeOutRow","fadeOutCol","$inject","cellEl","indexOf","dragOverCell","position","cells","isNode","cell","add","id","dragOverElement","bounds","getBoundingClientRect","clientX","left","width","clientY","top","height","draggedRow","getRowBelow","getRowAbove","draggedCol","getColRight","getColLeft","Math","max","min","length","firstOutput","filter","firstOutputIndex","inputs","lastInput","lastInputIndex","node","nodeType"],"mappings":"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","file":"DragAndDrop.js","sourcesContent":["import {\r\n  classes as domClasses,\r\n  domify,\r\n  queryAll as domQueryAll,\r\n  remove as domRemove\r\n} from 'min-dom';\r\n\r\nimport { isInput, isOutput } from 'dmn-js-shared/lib/util/ModelUtil';\r\n\r\nimport { Row, Col } from 'table-js/lib/model';\r\n\r\nimport { forEach } from 'min-dash';\r\n\r\nconst TOP = 'top',\r\n      RIGHT = 'right',\r\n      BOTTOM = 'bottom',\r\n      LEFT = 'left';\r\n\r\n\r\nexport default class DragAndDrop {\r\n\r\n  constructor(\r\n      components, elementRegistry, eventBus,\r\n      dragAndDrop, renderer, rules, sheet) {\r\n\r\n    this._elementRegistry = elementRegistry;\r\n    this._dragAndDrop = dragAndDrop;\r\n    this._renderer = renderer;\r\n    this._rules = rules;\r\n    this._sheet = sheet;\r\n\r\n    // provide drag handle for drag and drop\r\n    components.onGetComponent('cell-inner', ({ cellType, col, row }) => {\r\n      if (cellType === 'rule-index') {\r\n        return () => <span\r\n          draggable=\"true\"\r\n          onDragStart={ e => this.startDrag(row, e) }\r\n          className=\"dmn-icon-drag vertical\"\r\n          title=\"Move rule\">&nbsp;</span>;\r\n      } else if (cellType === 'input-cell' || cellType === 'output-cell') {\r\n\r\n        let title = `Move ${isInput(col) ? 'Input' : 'Output' }`;\r\n\r\n        return () => <span\r\n          draggable=\"true\"\r\n          onDragStart={ e => this.startDrag(col, e) }\r\n          className=\"dmn-icon-drag horizontal\"\r\n          title={ title }></span>;\r\n      }\r\n    });\r\n\r\n    // validate allowed rules\r\n    eventBus.on('dragAndDrop.dragEnter', (event) => {\r\n\r\n      const {\r\n        dragContext\r\n      } = event;\r\n\r\n      const {\r\n        draggedElement,\r\n        hoverEl\r\n      } = dragContext;\r\n\r\n      // can always drag rows\r\n      if (draggedElement instanceof Row) {\r\n        return true;\r\n      }\r\n\r\n      if (draggedElement instanceof Col) {\r\n        const dropIndex = getTargetColIndex(hoverEl, this._elementRegistry, this._sheet);\r\n\r\n        // cannot drop as we cannot compute the drop index\r\n        if (dropIndex === -1) {\r\n          return false;\r\n        }\r\n\r\n        const allowed = this._rules.allowed('col.move', {\r\n          col: draggedElement,\r\n          index: dropIndex\r\n        });\r\n\r\n        return allowed;\r\n      }\r\n\r\n      return false;\r\n    });\r\n\r\n    // clear previous UI\r\n    eventBus.on('dragAndDrop.dragLeave', (event) => {\r\n\r\n      const {\r\n        dragContext\r\n      } = event;\r\n\r\n      const {\r\n        targetEl\r\n      } = dragContext;\r\n\r\n      if (!targetEl) {\r\n        return;\r\n      }\r\n\r\n      const container = this._renderer.getContainer();\r\n\r\n      removeHighlight(container);\r\n    });\r\n\r\n    // update UI\r\n    eventBus.on('dragAndDrop.dragOver', (event) => {\r\n\r\n      const {\r\n        dragContext,\r\n        originalEvent\r\n      } = event;\r\n\r\n      const {\r\n        draggedElement,\r\n        lastPosition,\r\n        targetEl\r\n      } = dragContext;\r\n\r\n      const container = this._renderer.getContainer();\r\n\r\n      if (!targetEl) {\r\n        return false;\r\n      }\r\n\r\n      let newPosition;\r\n\r\n      if (draggedElement instanceof Row) {\r\n        newPosition = getVerticalPosition(\r\n          originalEvent,\r\n          targetEl\r\n        );\r\n      }\r\n\r\n      if (draggedElement instanceof Col) {\r\n        newPosition = getHorizontalPosition(\r\n          originalEvent,\r\n          targetEl\r\n        );\r\n      }\r\n\r\n      // nothing to do\r\n      if (lastPosition === newPosition) {\r\n        return true;\r\n      }\r\n\r\n      // remove old highlight\r\n      removeHighlight(container);\r\n\r\n      if (draggedElement instanceof Row) {\r\n\r\n        if (newPosition === TOP) {\r\n\r\n          // drop above\r\n          highlightRow(targetEl, container, 'top');\r\n        } else {\r\n\r\n          // drop below\r\n          highlightRow(targetEl, container, 'bottom');\r\n        }\r\n      }\r\n\r\n      if (draggedElement instanceof Col) {\r\n        if (newPosition === LEFT) {\r\n\r\n          // drop left\r\n          highlightCol(targetEl, container, 'left');\r\n        } else {\r\n\r\n          // drop right\r\n          highlightCol(targetEl, container, 'right');\r\n        }\r\n      }\r\n\r\n      // remember position\r\n      dragContext.lastPosition = newPosition;\r\n\r\n      // allowed\r\n      return true;\r\n    });\r\n\r\n\r\n    // perform drop operation\r\n    eventBus.on('dragAndDrop.drop', (event) => {\r\n\r\n      const {\r\n        dragContext,\r\n        originalEvent\r\n      } = event;\r\n\r\n      const {\r\n        draggedElement,\r\n        targetEl\r\n      } = dragContext;\r\n\r\n      if (!targetEl) {\r\n        return false;\r\n      }\r\n\r\n      if (draggedElement instanceof Row) {\r\n        const verticalPosition = getVerticalPosition(\r\n          originalEvent,\r\n          targetEl\r\n        );\r\n\r\n        const rowId = targetEl.dataset.rowId,\r\n              row = this._elementRegistry.get(rowId);\r\n\r\n        if (!row || row === draggedElement) {\r\n          return;\r\n        }\r\n\r\n        const targetRow = getTargetRow(\r\n          draggedElement,\r\n          row,\r\n          verticalPosition,\r\n          this._sheet.getRoot().rows\r\n        );\r\n\r\n        if (targetRow === draggedElement) {\r\n          return;\r\n        }\r\n\r\n        return targetRow;\r\n      }\r\n\r\n      if (draggedElement instanceof Col) {\r\n        const horizontalPosition = getHorizontalPosition(\r\n          originalEvent,\r\n          targetEl\r\n        );\r\n\r\n        // no need to check rules; we verified on\r\n        // dragEnter that dropping is O.K.\r\n        const colId = targetEl.dataset.colId,\r\n              col = this._elementRegistry.get(colId);\r\n\r\n        if (!col || col === draggedElement) {\r\n          return;\r\n        }\r\n\r\n        const targetCol = getTargetCol(\r\n          draggedElement,\r\n          col,\r\n          horizontalPosition,\r\n          this._sheet.getRoot().cols\r\n        );\r\n\r\n        if (targetCol === draggedElement) {\r\n          return;\r\n        }\r\n\r\n        return targetCol;\r\n      }\r\n    });\r\n\r\n    eventBus.on('dragAndDrop.dragEnd', this._cleanup);\r\n  }\r\n\r\n  startDrag(element, event) {\r\n    const container = this._renderer.getContainer();\r\n\r\n    this._dragImage = domify(\r\n      `<span style=\"\r\n          visibility: hidden;\r\n          position: fixed;\r\n          top: -10000px\r\n      \"></span>`\r\n    );\r\n\r\n    // needs to be present in DOM\r\n    document.body.appendChild(this._dragImage);\r\n\r\n    // QUIRK: not supported by Edge and Internet Explorer\r\n    if (event.dataTransfer.setDragImage) {\r\n      event.dataTransfer.setDragImage(this._dragImage, 0, 0);\r\n    }\r\n\r\n    if (element instanceof Row) {\r\n      fadeOutRow(element, container);\r\n    } else if (element instanceof Col) {\r\n      fadeOutCol(element, container);\r\n    }\r\n\r\n    this._dragAndDrop.startDrag(element, event);\r\n  }\r\n\r\n  _cleanup = () => {\r\n    const container = this._renderer.getContainer();\r\n\r\n    removeHighlight(container);\r\n    removeFadeOut(container);\r\n\r\n    if (this._dragImage) {\r\n      domRemove(this._dragImage);\r\n\r\n      this._dragImage = null;\r\n    }\r\n  }\r\n\r\n}\r\n\r\nDragAndDrop.$inject = [\r\n  'components',\r\n  'elementRegistry',\r\n  'eventBus',\r\n  'dragAndDrop',\r\n  'renderer',\r\n  'rules',\r\n  'sheet'\r\n];\r\n\r\n// helpers //////////\r\n\r\nfunction getTargetColIndex(cellEl, elementRegistry, sheet) {\r\n  const targetCol = elementRegistry.get(cellEl.dataset.colId);\r\n\r\n  if (!targetCol) {\r\n    return -1;\r\n  }\r\n\r\n  const { cols } = sheet.getRoot();\r\n\r\n  return cols.indexOf(targetCol);\r\n}\r\n\r\nfunction highlightRow(dragOverCell, container, position) {\r\n  const rowId = dragOverCell.dataset.rowId;\r\n\r\n  if (!rowId) {\r\n    return;\r\n  }\r\n\r\n  const cells = domQueryAll(`[data-row-id=${rowId}]`, container);\r\n\r\n  forEach(cells, cell => {\r\n\r\n    // QUIRK: PhantomJS might return object instead of NodeList\r\n    if (isNode(cell)) {\r\n      domClasses(cell).add('dragover');\r\n      domClasses(cell).add(position);\r\n    }\r\n  });\r\n}\r\n\r\nfunction highlightCol(dragOverCell, container, position) {\r\n  const colId = dragOverCell.dataset.colId;\r\n\r\n  if (!colId) {\r\n    return;\r\n  }\r\n\r\n  const cells = domQueryAll(`[data-col-id=${colId}]`, container);\r\n\r\n  forEach(cells, cell => {\r\n\r\n    // QUIRK: PhantomJS might return object instead of NodeList\r\n    if (isNode(cell)) {\r\n      domClasses(cell).add('dragover');\r\n      domClasses(cell).add(position);\r\n    }\r\n  });\r\n}\r\n\r\nfunction removeHighlight(container) {\r\n  const cells = domQueryAll('.dragover', container);\r\n\r\n  forEach(cells, cell => {\r\n\r\n    // QUIRK: PhantomJS might return object instead of NodeList\r\n    if (isNode(cell)) {\r\n      domClasses(cell).remove('dragover');\r\n      domClasses(cell).remove('top');\r\n      domClasses(cell).remove('right');\r\n      domClasses(cell).remove('bottom');\r\n      domClasses(cell).remove('left');\r\n    }\r\n  });\r\n}\r\n\r\nfunction fadeOutRow(row, container) {\r\n  const cells = domQueryAll(`[data-row-id=${row.id}]`, container);\r\n\r\n  forEach(cells, cell => {\r\n\r\n    // QUIRK: PhantomJS might return object instead of NodeList\r\n    if (isNode(cell)) {\r\n      domClasses(cell).add('dragged');\r\n    }\r\n  });\r\n}\r\n\r\nfunction fadeOutCol(col, container) {\r\n  const cells = domQueryAll(`[data-col-id=${col.id}]`, container);\r\n\r\n  forEach(cells, cell => {\r\n\r\n    // QUIRK: PhantomJS might return object instead of NodeList\r\n    if (isNode(cell)) {\r\n      domClasses(cell).add('dragged');\r\n    }\r\n  });\r\n}\r\n\r\nfunction removeFadeOut(container) {\r\n  const cells = domQueryAll('.dragged', container);\r\n\r\n  forEach(cells, cell => {\r\n\r\n    // QUIRK: PhantomJS might return object instead of NodeList\r\n    if (isNode(cell)) {\r\n      domClasses(cell).remove('dragged');\r\n    }\r\n  });\r\n}\r\n\r\nfunction getHorizontalPosition(event, dragOverElement) {\r\n  const bounds = dragOverElement.getBoundingClientRect();\r\n\r\n  return event.clientX < (bounds.left + bounds.width / 2)\r\n    ? LEFT\r\n    : RIGHT;\r\n}\r\n\r\nfunction getVerticalPosition(event, dragOverElement) {\r\n  const bounds = dragOverElement.getBoundingClientRect();\r\n\r\n  return event.clientY < (bounds.top + bounds.height / 2)\r\n    ? TOP\r\n    : BOTTOM;\r\n}\r\n\r\nfunction getTargetRow(draggedRow, targetRow, verticalPosition, rows) {\r\n  if (rows.indexOf(draggedRow) > rows.indexOf(targetRow)) {\r\n    targetRow = getRowBelow(targetRow, rows);\r\n  }\r\n\r\n  if (verticalPosition === TOP) {\r\n\r\n    // return row above or row\r\n    return getRowAbove(targetRow, rows);\r\n  } else {\r\n\r\n    // return row\r\n    return targetRow;\r\n  }\r\n}\r\n\r\nfunction getTargetCol(draggedCol, targetCol, horizontalPosition, cols) {\r\n  if (cols.indexOf(draggedCol) > cols.indexOf(targetCol)) {\r\n    targetCol = getColRight(targetCol, cols);\r\n  }\r\n\r\n  if (horizontalPosition === LEFT) {\r\n\r\n    // return col left or col\r\n    return getColLeft(targetCol, cols);\r\n  } else {\r\n\r\n    // return col\r\n    return targetCol;\r\n  }\r\n}\r\n\r\nfunction getRowAbove(row, rows) {\r\n  const index = rows.indexOf(row);\r\n\r\n  return rows[ Math.max(0, index - 1) ];\r\n}\r\n\r\nfunction getRowBelow(row, rows) {\r\n  const index = rows.indexOf(row);\r\n\r\n  return rows[ Math.min(rows.length - 1, index + 1) ];\r\n}\r\n\r\nfunction getColLeft(col, cols) {\r\n  const index = cols.indexOf(col);\r\n\r\n  if (isOutput(col)) {\r\n    const firstOutput = cols.filter(col => isOutput(col))[0];\r\n\r\n    const firstOutputIndex = cols.indexOf(firstOutput);\r\n\r\n    return cols[ Math.max(firstOutputIndex, index - 1) ];\r\n  }\r\n\r\n  return cols[ Math.max(0, index - 1) ];\r\n}\r\n\r\nfunction getColRight(col, cols) {\r\n  const index = cols.indexOf(col);\r\n\r\n  if (isInput(col)) {\r\n    const inputs = cols.filter(col => isInput(col));\r\n\r\n    const lastInput = inputs[ inputs.length - 1 ];\r\n\r\n    const lastInputIndex = cols.indexOf(lastInput);\r\n\r\n    return cols[ Math.min(lastInputIndex, index + 1) ];\r\n  }\r\n\r\n  return cols[ Math.min(cols.length - 1, index + 1) ];\r\n}\r\n\r\n// QUIRK: PhantomJS requires check if actual DOM node\r\nfunction isNode(node) {\r\n  return node && (node.nodeType === 1 || node.nodeType == 11);\r\n}"]}