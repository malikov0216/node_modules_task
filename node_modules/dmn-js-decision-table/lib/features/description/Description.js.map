{"version":3,"sources":["../../../src/features/description/Description.js"],"names":["isString","getNodeById","DescriptionEditor","LOW_PRIORITY","LOWER_PRIORITY","OFFSET_X","Description","components","contextMenu","elementRegistry","eventBus","modeling","renderer","addDescription","cell","_modeling","updateProperties","description","container","_renderer","getContainer","node","id","bounds","getBoundingClientRect","position","getPosition","_contextMenu","open","contextMenuType","autoFocus","offset","x","y","removeDescription","close","on","event","defaultPrevented","target","element","get","getDescription","preventDefault","onGetComponent","context","businessObject","existingDescription","className","onClick","icon","$inject","top","left","width","height","parentNode","scrollLeft","scrollTop"],"mappings":"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","file":"Description.js","sourcesContent":["import { isString } from 'min-dash';\r\n\r\nimport {\r\n  getNodeById\r\n} from '../cell-selection/CellSelectionUtil';\r\n\r\nimport DescriptionEditor from './components/DescriptionEditor';\r\n\r\nconst LOW_PRIORITY = 500;\r\n\r\nconst LOWER_PRIORITY = 750;\r\n\r\nconst OFFSET_X = 26;\r\n\r\n\r\nexport default class Description {\r\n\r\n  constructor(\r\n      components, contextMenu, elementRegistry,\r\n      eventBus, modeling, renderer) {\r\n\r\n    this._contextMenu = contextMenu;\r\n    this._modeling = modeling;\r\n    this._renderer = renderer;\r\n\r\n\r\n    eventBus.on('cell.click', LOWER_PRIORITY, (event) => {\r\n\r\n      if (event.defaultPrevented) {\r\n        return;\r\n      }\r\n\r\n      const {\r\n        target,\r\n        id\r\n      } = event;\r\n\r\n      const element = elementRegistry.get(id);\r\n\r\n      if (!element) {\r\n        return;\r\n      }\r\n\r\n      const description = getDescription(element);\r\n\r\n      if (!description) {\r\n        // prevent focus\r\n        event.preventDefault();\r\n      }\r\n\r\n      const container = renderer.getContainer(),\r\n            bounds = target.getBoundingClientRect();\r\n\r\n      const position = getPosition(container, bounds);\r\n\r\n      contextMenu.open(position, {\r\n        contextMenuType: 'cell-description',\r\n        autoFocus: false,\r\n        id,\r\n        offset: {\r\n          x: 4,\r\n          y: 4\r\n        }\r\n      });\r\n    });\r\n\r\n    components.onGetComponent('context-menu', (context = {}) => {\r\n      if (context.contextMenuType\r\n        && context.contextMenuType === 'cell-description') {\r\n\r\n        const element = elementRegistry.get(context.id);\r\n\r\n        const description = getDescription(element);\r\n\r\n        if (isString(description)) {\r\n          return DescriptionEditor;\r\n        }\r\n      }\r\n    });\r\n\r\n    components.onGetComponent('context-menu-cell-additional', LOW_PRIORITY,\r\n      (context = {}) => {\r\n        if (context.contextMenuType\r\n          && context.contextMenuType === 'context-menu') {\r\n\r\n          const { id } = context;\r\n\r\n          if (!id) {\r\n            return;\r\n          }\r\n\r\n          const element = elementRegistry.get(id);\r\n\r\n          // element might not be in element registry (e.g. cut)\r\n          if (!element) {\r\n            return;\r\n          }\r\n\r\n          const { businessObject } = element;\r\n\r\n          const { description } = businessObject;\r\n\r\n          const existingDescription = isString(description);\r\n\r\n          const className =\r\n            existingDescription\r\n              ? 'remove-description'\r\n              : 'add-description';\r\n\r\n          const onClick =\r\n            existingDescription\r\n              ? () => this.removeDescription(element)\r\n              : () => this.addDescription(element);\r\n\r\n          const icon =\r\n            existingDescription\r\n              ? 'dmn-icon-clear'\r\n              : 'dmn-icon-plus';\r\n\r\n          return (\r\n            <div\r\n              className={ `context-menu-group-entry ${ className }` }\r\n              onClick={ onClick }>\r\n              <span className={ `context-menu-group-entry-icon ${ icon }` }></span>\r\n              { isString(description) ? 'Remove' : 'Add' } Description\r\n            </div>\r\n          );\r\n        }\r\n      });\r\n  }\r\n\r\n  addDescription = (cell) => {\r\n    this._modeling.updateProperties(cell, {\r\n      description: ''\r\n    });\r\n\r\n    const container = this._renderer.getContainer();\r\n\r\n    const node = getNodeById(cell.id, container);\r\n\r\n    const bounds = node.getBoundingClientRect();\r\n\r\n    const position = getPosition(container, bounds);\r\n\r\n    this._contextMenu.open(position, {\r\n      contextMenuType: 'cell-description',\r\n      id: cell.id,\r\n      autoFocus: true,\r\n      offset: {\r\n        x: 4,\r\n        y: 4\r\n      }\r\n    });\r\n  }\r\n\r\n  removeDescription = (cell) => {\r\n    this._modeling.updateProperties(cell, {\r\n      description: null\r\n    });\r\n\r\n    this._contextMenu.close();\r\n  }\r\n}\r\n\r\nDescription.$inject = [\r\n  'components',\r\n  'contextMenu',\r\n  'elementRegistry',\r\n  'eventBus',\r\n  'modeling',\r\n  'renderer'\r\n];\r\n\r\n// helpers //////////\r\n\r\nfunction getPosition(container, bounds) {\r\n  const { top, left, width, height } = bounds;\r\n\r\n  return {\r\n    x: left + container.parentNode.scrollLeft - OFFSET_X,\r\n    y: top + container.parentNode.scrollTop,\r\n    width: width + (2 * OFFSET_X),\r\n    height\r\n  };\r\n}\r\n\r\nfunction getDescription(element) {\r\n  return element\r\n    && element.businessObject\r\n    && element.businessObject.description;\r\n}"]}