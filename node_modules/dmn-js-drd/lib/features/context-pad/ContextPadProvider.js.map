{"version":3,"sources":["../../../src/features/context-pad/ContextPadProvider.js"],"names":["assign","isArray","is","isAny","hasPrimaryModifier","ContextPadProvider","eventBus","contextPad","modeling","elementFactory","connect","create","rules","popupMenu","canvas","translate","registerProvider","_contextPad","_modeling","_elementFactory","_connect","_create","_rules","_popupMenu","_canvas","_translate","on","event","shape","context","entries","getEntries","replace","action","click","$inject","prototype","getContextPadEntries","element","actions","type","businessObject","startConnect","autoActivate","start","removeElement","e","removeElements","getReplaceMenuPosition","Y_OFFSET","diagramContainer","getContainer","pad","getPad","html","diagramRect","getBoundingClientRect","padRect","top","left","pos","x","y","height","appendAction","className","title","options","appendListener","createShape","group","dragstart","isEmpty","position","cursor","open","deleteAllowed","allowed","elements"],"mappings":"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","file":"ContextPadProvider.js","sourcesContent":["import {\n  assign,\n  isArray\n} from 'min-dash';\n\nimport {\n  is,\n  isAny\n} from 'dmn-js-shared/lib/util/ModelUtil';\n\nimport {\n  hasPrimaryModifier\n} from 'diagram-js/lib/util/Mouse';\n\n\n/**\n* A provider for DMN 1.1 elements context pad\n*/\nexport default function ContextPadProvider(\n    eventBus, contextPad, modeling,\n    elementFactory, connect, create,\n    rules, popupMenu, canvas,\n    translate) {\n\n  contextPad.registerProvider(this);\n\n  this._contextPad = contextPad;\n\n  this._modeling = modeling;\n\n  this._elementFactory = elementFactory;\n  this._connect = connect;\n  this._create = create;\n  this._rules = rules;\n  this._popupMenu = popupMenu;\n  this._canvas = canvas;\n  this._translate = translate;\n\n\n  eventBus.on('create.end', 250, function(event) {\n    var shape = event.context.shape;\n\n    if (!hasPrimaryModifier(event)) {\n      return;\n    }\n\n    var entries = contextPad.getEntries(shape);\n\n    if (entries.replace) {\n      entries.replace.action.click(event, shape);\n    }\n  });\n}\n\nContextPadProvider.$inject = [\n  'eventBus',\n  'contextPad',\n  'modeling',\n  'elementFactory',\n  'connect',\n  'create',\n  'rules',\n  'popupMenu',\n  'canvas',\n  'translate'\n];\n\n\nContextPadProvider.prototype.getContextPadEntries = function(element) {\n\n  var modeling = this._modeling,\n\n      elementFactory = this._elementFactory,\n      connect = this._connect,\n      create = this._create,\n      popupMenu = this._popupMenu,\n      canvas = this._canvas,\n      contextPad = this._contextPad,\n      rules = this._rules,\n      translate = this._translate;\n\n  var actions = {};\n\n  if (element.type === 'label') {\n    return actions;\n  }\n\n  var businessObject = element.businessObject;\n\n  function startConnect(event, element, autoActivate) {\n    connect.start(event, element, autoActivate);\n  }\n\n  function removeElement(e) {\n    modeling.removeElements([ element ]);\n  }\n\n  function getReplaceMenuPosition(element) {\n\n    var Y_OFFSET = 5;\n\n    var diagramContainer = canvas.getContainer(),\n        pad = contextPad.getPad(element).html;\n\n    var diagramRect = diagramContainer.getBoundingClientRect(),\n        padRect = pad.getBoundingClientRect();\n\n    var top = padRect.top - diagramRect.top;\n    var left = padRect.left - diagramRect.left;\n\n    var pos = {\n      x: left,\n      y: top + padRect.height + Y_OFFSET\n    };\n\n    return pos;\n  }\n\n  /**\n  * Create an append action\n  *\n  * @param {String} type\n  * @param {String} className\n  * @param {String} [title]\n  * @param {Object} [options]\n  *\n  * @return {Object} descriptor\n  */\n  function appendAction(type, className, title, options) {\n\n    if (typeof title !== 'string') {\n      options = title;\n      title = translate('Append {type}', { type: type.replace(/^dmn:/, '') });\n    }\n\n    function appendListener(event, element) {\n\n      var shape = elementFactory.createShape(assign({ type: type }, options));\n      create.start(event, shape, element);\n    }\n\n    return {\n      group: 'model',\n      className: className,\n      title: title,\n      action: {\n        dragstart: appendListener,\n        click: appendListener\n      }\n    };\n  }\n\n  if (\n    isAny(businessObject, [\n      'dmn:InputData',\n      'dmn:BusinessKnowledgeModel',\n      'dmn:KnowledgeSource',\n      'dmn:Decision'\n    ])\n  ) {\n    assign(actions, {\n      'append.decision': appendAction('dmn:Decision', 'dmn-icon-decision')\n    });\n  }\n\n  if (\n    isAny(businessObject, [\n      'dmn:InputData',\n      'dmn:Decision',\n      'dmn:KnowledgeSource'\n    ])\n  ) {\n    assign(actions, {\n      'append.knowledge-source': appendAction(\n        'dmn:KnowledgeSource',\n        'dmn-icon-knowledge-source'\n      )\n    });\n  }\n\n  if (isAny(businessObject, [ 'dmn:BusinessKnowledgeModel', 'dmn:KnowledgeSource' ])) {\n    assign(actions, {\n      'append.business-knowledge-model': appendAction(\n        'dmn:BusinessKnowledgeModel',\n        'dmn-icon-business-knowledge'\n      )\n    });\n  }\n\n  if (isAny(businessObject, [ 'dmn:Decision' ])) {\n    assign(actions, {\n      'append.input-data': appendAction('dmn:InputData', 'dmn-icon-input-data')\n    });\n  }\n\n  if (is(businessObject, 'dmn:DRGElement')) {\n\n    assign(actions, {\n      'append.text-annotation': appendAction(\n        'dmn:TextAnnotation',\n        'dmn-icon-text-annotation'\n      ),\n\n      'connect': {\n        group: 'connect',\n        className: 'dmn-icon-connection-multi',\n        title: translate(\n          'Connect using Information/Knowledge' +\n          '/Authority Requirement or Association'\n        ),\n        action: {\n          click: startConnect,\n          dragstart: startConnect\n        }\n      }\n    });\n  }\n\n  if (!popupMenu.isEmpty(element, 'dmn-replace')) {\n\n    // Replace menu entry\n    assign(actions, {\n      'replace': {\n        group: 'edit',\n        className: 'dmn-icon-screw-wrench',\n        title: translate('Change type'),\n        action: {\n          click: function(event, element) {\n\n            var position = assign(getReplaceMenuPosition(element), {\n              cursor: { x: event.x, y: event.y }\n            });\n\n            popupMenu.open(element, 'dmn-replace', position);\n          }\n        }\n      }\n    });\n  }\n\n\n  // delete element entry, only show if allowed by rules\n  var deleteAllowed = rules.allowed('elements.delete', { elements: [ element ] });\n\n  if (isArray(deleteAllowed)) {\n    // was the element returned as a deletion candidate?\n    deleteAllowed = deleteAllowed[0] === element;\n  }\n\n  if (deleteAllowed) {\n    assign(actions, {\n      'delete': {\n        group: 'edit',\n        className: 'dmn-icon-trash',\n        title: translate('Remove'),\n        action: {\n          click: removeElement\n        }\n      }\n    });\n  }\n\n  return actions;\n};\n"]}