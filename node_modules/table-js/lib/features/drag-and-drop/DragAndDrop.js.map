{"version":3,"sources":["../../../src/features/drag-and-drop/DragAndDrop.js"],"names":["Row","Col","closest","domClosest","event","domEvent","TARGET_SELECTOR","DragAndDrop","eventBus","renderer","modeling","sheet","handleDragOver","stopEvent","targetEl","target","cellEl","allowed","hoverEl","_dragContext","_emit","dataTransfer","dropEffect","handleDrop","draggedElement","_sheet","getRoot","rows","index","indexOf","_modeling","moveRow","cols","moveCol","handleDragEnd","_unbindListeners","_eventBus","_renderer","on","bind","document","unbind","eventName","originalEvent","fire","dragContext","element","effectAllowed","setData","_bindListeners","$inject","preventDefault","stopPropagation"],"mappings":"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","file":"DragAndDrop.js","sourcesContent":["import { Row, Col } from '../../model';\r\n\r\nimport {\r\n  closest as domClosest,\r\n  event as domEvent\r\n} from 'min-dom';\r\n\r\nconst TARGET_SELECTOR =\r\n  `.dmn-decision-table-container td,\r\n   .dmn-decision-table-container th`;\r\n\r\nexport default class DragAndDrop {\r\n  constructor(eventBus, renderer, modeling, sheet) {\r\n    this._eventBus = eventBus;\r\n    this._renderer = renderer;\r\n    this._modeling = modeling;\r\n    this._sheet = sheet;\r\n\r\n    this._dragContext = null;\r\n\r\n    eventBus.on('table.destroy', () => {\r\n      this._unbindListeners();\r\n    });\r\n  }\r\n\r\n  _bindListeners() {\r\n    domEvent.bind(document, 'dragover', this.handleDragOver);\r\n    domEvent.bind(document, 'drop', this.handleDrop);\r\n    domEvent.bind(document, 'dragend', this.handleDragEnd);\r\n  }\r\n\r\n  _unbindListeners() {\r\n    domEvent.unbind(document, 'dragover', this.handleDragOver);\r\n    domEvent.unbind(document, 'drop', this.handleDrop);\r\n    domEvent.unbind(document, 'dragend', this.handleDragEnd);\r\n  }\r\n\r\n  _emit(eventName, originalEvent) {\r\n\r\n    return this._eventBus.fire(eventName, {\r\n      dragContext: this._dragContext,\r\n      originalEvent\r\n    });\r\n  }\r\n\r\n  startDrag(element, event) {\r\n\r\n    stopEvent(event, true);\r\n\r\n    event.dataTransfer.effectAllowed = 'move';\r\n\r\n    // QUIRK: Firefox won't fire events unless data was set\r\n    if (event.dataTransfer.setData) {\r\n      event.dataTransfer.setData('text', '__DUMMY');\r\n    }\r\n\r\n    this._dragContext = {\r\n      draggedElement: element\r\n    };\r\n\r\n    this._bindListeners();\r\n\r\n    this._emit('dragAndDrop.dragStart', event);\r\n  }\r\n\r\n  handleDragOver = (event) => {\r\n\r\n    // we're taking over (!)\r\n    stopEvent(event);\r\n\r\n    const targetEl = event.target;\r\n\r\n    const cellEl = domClosest(targetEl, TARGET_SELECTOR, true);\r\n\r\n    let allowed = !!cellEl;\r\n\r\n    const {\r\n      hoverEl\r\n    } = this._dragContext;\r\n\r\n    // drag leave\r\n    if (hoverEl && hoverEl !== cellEl) {\r\n      this._emit('dragAndDrop.dragLeave', event);\r\n\r\n      // unset target element\r\n      this._dragContext.targetEl = null;\r\n\r\n      // unset hover element\r\n      this._dragContext.hoverEl = null;\r\n    }\r\n\r\n    if (cellEl) {\r\n\r\n      // drag enter\r\n      if (cellEl !== hoverEl) {\r\n\r\n        // new hover element\r\n        this._dragContext.hoverEl = cellEl;\r\n\r\n        allowed = this._emit('dragAndDrop.dragEnter', event);\r\n\r\n        if (allowed !== false) {\r\n          // new targetEl\r\n          this._dragContext.targetEl = cellEl;\r\n        }\r\n      }\r\n\r\n      // drag over\r\n      allowed = this._emit('dragAndDrop.dragOver', event);\r\n    }\r\n\r\n    event.dataTransfer.dropEffect = allowed !== false ? 'move' : 'none';\r\n  }\r\n\r\n  handleDrop = (event) => {\r\n\r\n    // prevent default drop action\r\n    // QUIRK: Firefox will redirect if not prevented\r\n    stopEvent(event);\r\n\r\n    const target = this._emit('dragAndDrop.drop', event);\r\n\r\n    if (target) {\r\n\r\n      const {\r\n        draggedElement\r\n      } = this._dragContext;\r\n\r\n      if (draggedElement instanceof Row) {\r\n        const { rows } = this._sheet.getRoot();\r\n\r\n        let index = rows.indexOf(target);\r\n\r\n        this._modeling.moveRow(draggedElement, index);\r\n      } else if (draggedElement instanceof Col) {\r\n        const { cols } = this._sheet.getRoot();\r\n\r\n        let index = cols.indexOf(target);\r\n\r\n        this._modeling.moveCol(draggedElement, index);\r\n      }\r\n    }\r\n\r\n    // manually call to drag end needed, as we prevent the default\r\n    // browser behavior / drag end handling via\r\n    // event.preventDefault();\r\n    this.handleDragEnd(event);\r\n  }\r\n\r\n  handleDragEnd = (event) => {\r\n\r\n    // prevent default drop action\r\n    stopEvent(event);\r\n\r\n    this._unbindListeners();\r\n    this._emit('dragAndDrop.dragEnd', event);\r\n\r\n    this._dragContext = null;\r\n  }\r\n\r\n}\r\n\r\nDragAndDrop.$inject = [\r\n  'eventBus',\r\n  'renderer',\r\n  'modeling',\r\n  'sheet'\r\n];\r\n\r\n\r\n\r\n// helpers /////////////////\r\n\r\nfunction stopEvent(event, preventDefault) {\r\n  event.stopPropagation();\r\n\r\n  if (preventDefault !== true) {\r\n    event.preventDefault();\r\n  }\r\n}"]}